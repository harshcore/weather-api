<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phonk Multi-Location Weather Dashboard</title>
  <style>
    /* ---------- Fonts & reset ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; }

    /* ---------- Page layout ---------- */
    body{
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#05010a 0%, #0a0312 60%);
      color: #e9eef8;
      min-height:100vh;
      display: flex;
      gap: 1.5rem;
      padding: 1.5rem;
      align-items: stretch;
    }

    /* Two-column container */
    .container {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 1.5rem;
      width: 100%;
      align-items: start;
    }

    /* Responsive fallback: single column on small screens */
    @media (max-width: 880px) {
      .container { grid-template-columns: 1fr; padding-bottom: 2rem; }
    }

    /* ---------- Left panel (controls) ---------- */
    .panel-left {
      background: linear-gradient(180deg, rgba(255,0,160,0.04), rgba(0,200,255,0.02));
      border: 1px solid rgba(255,0,160,0.08);
      border-radius: 14px;
      padding: 1.1rem;
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      display:flex;
      flex-direction:column;
      gap: 1rem;
      height: calc(100vh - 3rem);
      overflow: auto;
    }

    .title {
      font-weight:700;
      letter-spacing:1px;
      color: #ff7ad9;
      text-shadow: 0 6px 20px rgba(255,0,160,0.12);
      font-size: 1.15rem;
    }

    .subtitle { color: #9fb4d9; font-size: 0.85rem; margin-bottom: .4rem; }

    .control-group { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }

    input[type="text"], input[type="number"]{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 0.6rem 0.8rem;
      color: #eaf2ff;
      border-radius: 8px;
      outline: none;
      min-width: 0;
      font-size: 0.95rem;
    }

    input[type="text"]:focus, input[type="number"]:focus { box-shadow: 0 6px 24px rgba(255,0,160,0.06); border-color: rgba(255,0,160,0.14); }

    .btn {
      background: linear-gradient(90deg,#ff007c,#00eaff);
      color:#03111a;
      padding: 0.55rem 0.9rem;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn.secondary {
      background: transparent;
      color: #d7eafe;
      border: 1px solid rgba(255,255,255,0.06);
      font-weight: 600;
    }

    /* Suggestions dropdown */
    .suggestions {
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,0,160,0.06);
      border-radius: 8px;
      overflow: auto;
      max-height: 220px;
      margin-top: 0.4rem;
    }
    .suggestions .item {
      padding: 0.6rem 0.8rem;
      cursor: pointer;
      border-bottom: 1px dashed rgba(255,255,255,0.02);
    }
    .suggestions .item:hover { background: rgba(255,0,160,0.06); color: #001018; }

    /* Quick selects (chips) */
    .chips {
      display:flex; gap:.5rem; flex-wrap:wrap;
    }
    .chip {
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.04);
      cursor:pointer;
      font-size:0.9rem;
      color:#f6f8ff;
    }
    .chip:hover { box-shadow: 0 6px 20px rgba(0,232,255,0.06); transform: translateY(-2px); }

    /* small utilities */
    .row { display:flex; gap:.6rem; align-items:center; }
    .muted { color: #9fb4d9; font-size: 0.85rem; }

    /* ---------- Right panel (dashboard) ---------- */
    .panel-right {
      background: linear-gradient(180deg, rgba(10,6,20,0.55), rgba(3,6,12,0.75));
      border: 1px solid rgba(0,200,255,0.03);
      border-radius: 14px;
      padding: 1rem;
      min-height: calc(100vh - 3rem);
      overflow: auto;
      box-shadow: 0 10px 40px rgba(1,2,6,0.7);
    }

    .toolbar {
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
      margin-bottom: 1rem;
    }
    .toolbar .left { display:flex; gap:.6rem; align-items:center; }

    /* Grid of location cards (responsive) */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
    }

    .location-card {
      border-radius: 12px;
      padding: 1rem;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,0,160,0.02));
      border: 1px solid rgba(255,0,160,0.04);
      position: relative;
      overflow: hidden;
      display:flex;
      flex-direction:column;
      gap:.6rem;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .location-card:hover { transform: translateY(-6px); box-shadow: 0 22px 45px rgba(0,0,0,0.6); }

    .card-header {
      display:flex; justify-content:space-between; align-items:center;
      gap:.6rem;
    }
    .loc-name { font-weight:700; color:#fd9cd9; font-size:1.05rem; }
    .loc-coords { font-size:0.85rem; color:#9fb4d9; }

    .small-grid {
      display:grid; grid-template-columns: 1fr 1fr; gap:.4rem .8rem; align-items:center;
      margin-top:.6rem;
    }
    .kv { display:flex; flex-direction:column; gap:0.18rem; }
    .k { font-size: .8rem; color:#9fb4d9; }
    .v { font-weight:700; font-size: 1rem; color:#e8f6ff; }

    .aqi-pill {
      padding: 0.28rem 0.6rem; border-radius: 999px; font-weight:700; font-size:0.9rem;
      display:inline-block;
    }
    .aqi-good { background: rgba(0,255,153,0.12); color: #00ff99; border:1px solid rgba(0,255,153,0.12); }
    .aqi-moderate { background: rgba(255,255,0,0.08); color: #fff200; border:1px solid rgba(255,255,0,0.06); }
    .aqi-unhealthy { background: rgba(255,120,0,0.08); color:#ff7b00; border:1px solid rgba(255,120,0,0.06); }
    .aqi-hazardous { background: rgba(255,0,70,0.08); color:#ff1244; border:1px solid rgba(255,0,70,0.06); }

    .card-actions { display:flex; gap:.5rem; margin-top:.6rem; }
    .icon-btn {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.03);
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      cursor:pointer;
      color:#eef8ff;
      font-weight:600;
    }

    /* tiny loader */
    .loader { font-size: 0.9rem; color:#9fb4d9; }
    .empty {
      color:#9fb4d9; text-align:center; padding: 2rem 0; border: 1px dashed rgba(255,255,255,0.03); border-radius:8px;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT: Controls + search -->
    <aside class="panel-left" aria-label="controls">
      <div>
        <div class="title">Atmospheric Intelligence</div>
        <div class="subtitle">Add multiple locations â€” auto-save in your browser</div>
      </div>

      <div>
        <label class="muted">Search city (type then pick)</label>
        <div style="margin-top:0.5rem">
          <input id="searchInput" type="text" placeholder="e.g. Tokyo, Mumbai, New York..." autocomplete="off" />
        </div>
        <div id="suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div>
        <div class="muted" style="margin-bottom:.4rem">Or add by coordinates</div>
        <div class="control-group">
          <input id="latInput" type="number" step="any" placeholder="Latitude" />
          <input id="lonInput" type="number" step="any" placeholder="Longitude" />
          <button class="btn" id="addCoordsBtn">Add</button>
        </div>
      </div>

      <div>
        <div class="muted">Quick selects</div>
        <div class="chips" id="quickChips" style="margin-top:.6rem">
          <!-- some default chips -->
          <div class="chip" data-lat="51.5072" data-lon="-0.1276">London</div>
          <div class="chip" data-lat="40.7128" data-lon="-74.0060">New York</div>
          <div class="chip" data-lat="35.6762" data-lon="139.6503">Tokyo</div>
          <div class="chip" data-lat="28.6139" data-lon="77.2090">Delhi</div>
          <div class="chip" data-lat="37.7749" data-lon="-122.4194">San Francisco</div>
        </div>
      </div>

      <div style="margin-top:1rem">
        <div class="muted">Actions</div>
        <div style="display:flex; gap:.6rem; margin-top:.6rem">
          <button class="btn" id="updateAllBtn">Refresh All</button>
          <button class="btn secondary" id="clearAllBtn">Clear All</button>
        </div>
      </div>

      <div style="margin-top:auto; padding-top:1rem">
        <div class="muted">Storage</div>
        <div style="margin-top:.5rem" class="muted">Saved locally (this browser). Use <strong>Clear All</strong> to remove.</div>
      </div>
    </aside>

    <!-- RIGHT: Dashboard -->
    <main class="panel-right" aria-label="dashboard">
      <div class="toolbar">
        <div class="left">
          <div style="font-weight:700; color:#a9e9ff">Locations</div>
          <div style="margin-left:.6rem; color:#9fb4d9; font-size:.92rem">Live weather & AQI</div>
        </div>
        <div class="right">
          <div id="status" class="loader">Idle</div>
        </div>
      </div>

      <section id="gridArea" class="grid">
        <!-- Location cards inserted here -->
      </section>

      <div id="emptyNotice" class="empty" style="display:none; margin-top:1rem">
        No locations yet â€” add a city or coordinates on the left.
      </div>
    </main>
  </div>

  <script>
    /**************************************************************************
     * Multi-location weather + AQI dashboard
     * - Geocoding from Open-Meteo for search suggestions
     * - Open-Meteo weather + Open-Meteo air-quality
     * - Persist locations in localStorage
     * - Defensive checks so missing API fields don't throw ReferenceErrors
     **************************************************************************/

    // --- State & DOM refs
    const STORAGE_KEY = 'phonk_locations_v2';
    let locations = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); // array of { id, name, lat, lon, data, lastUpdated }
    const gridArea = document.getElementById('gridArea');
    const emptyNotice = document.getElementById('emptyNotice');
    const status = document.getElementById('status');

    const searchInput = document.getElementById('searchInput');
    const suggestionsEl = document.getElementById('suggestions');

    const latInput = document.getElementById('latInput');
    const lonInput = document.getElementById('lonInput');
    const addCoordsBtn = document.getElementById('addCoordsBtn');

    const updateAllBtn = document.getElementById('updateAllBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');

    // helper: generate unique id
    const uid = () => 'loc_' + Math.random().toString(36).slice(2,9);

    // helper class pickers
    function aqiClassFromNumber(n){
      if (n === null || isNaN(n)) return '';
      if (n <= 50) return 'aqi-good';
      if (n <= 100) return 'aqi-moderate';
      if (n <= 150) return 'aqi-unhealthy';
      return 'aqi-hazardous';
    }
    function aqiLabelFromNumber(n){
      if (n === null || isNaN(n)) return 'N/A';
      if (n <= 50) return 'Good';
      if (n <= 100) return 'Moderate';
      if (n <= 150) return 'Unhealthy';
      return 'Hazardous';
    }

    // save & load
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
    }

    // ---------- API calls ----------
    async function fetchWeather(lat, lon){
      const weatherURL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,surface_pressure,cloud_cover,relative_humidity_2m,dew_point_2m`;
      const res = await fetch(weatherURL);
      if (!res.ok) throw new Error('Weather API error');
      const json = await res.json();
      return json;
    }
    async function fetchAqi(lat, lon){
      const aqiURL = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=us_aqi`;
      const res = await fetch(aqiURL);
      if (!res.ok) throw new Error('AQI API error');
      const json = await res.json();
      return json;
    }

    // Geocoding suggestions (open-meteo geocoding)
    let geocodeToken = 0;
    async function geocodeQuery(q){
      const token = ++geocodeToken;
      if (!q || q.length < 2) { suggestionsEl.style.display = 'none'; return; }
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=7&language=en&format=json`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        // ignore results if a newer input arrived
        if (token !== geocodeToken) return;
        if (!data || !Array.isArray(data.results) || data.results.length === 0){
          suggestionsEl.innerHTML = `<div class="item">No results</div>`;
          suggestionsEl.style.display = 'block';
          return;
        }
        suggestionsEl.innerHTML = data.results.map(r => {
          const display = `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ', ' + r.country : ''}`;
          return `<div class="item" data-lat="${r.latitude}" data-lon="${r.longitude}" data-name="${escapeHtml(display)}">${escapeHtml(display)}</div>`;
        }).join('');
        suggestionsEl.style.display = 'block';
      } catch (err){
        suggestionsEl.innerHTML = `<div class="item">Error</div>`;
        suggestionsEl.style.display = 'block';
      }
    }

    // ---------- Rendering ----------
    function updateEmptyState(){
      emptyNotice.style.display = locations.length === 0 ? 'block' : 'none';
    }

    function escapeHtml(s){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    function render(){
      gridArea.innerHTML = '';
      if (locations.length === 0){
        updateEmptyState();
        status.textContent = 'No locations';
        return;
      }
      updateEmptyState();
      status.textContent = `Showing ${locations.length} location(s)`;
      locations.forEach((loc, idx) => {
        const data = loc.data || {};
        const aqiNum = (data.aqi === undefined || data.aqi === null) ? null : Number(data.aqi);
        const aqiClass = aqiClassFromNumber(aqiNum);
        const aqiLabel = aqiLabelFromNumber(aqiNum);
        const updated = loc.lastUpdated ? new Date(loc.lastUpdated).toLocaleString() : 'â€”';

        const card = document.createElement('article');
        card.className = 'location-card';
        card.innerHTML = `
          <div class="card-header">
            <div>
              <div class="loc-name">${escapeHtml(loc.name || 'Unknown')}</div>
              <div class="loc-coords">${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:.88rem; color:#9fb4d9">${updated}</div>
              <div style="margin-top:.3rem">
                <button class="icon-btn" data-action="refresh" title="Refresh">â†»</button>
                <button class="icon-btn" data-action="remove" title="Remove">ðŸ—‘</button>
              </div>
            </div>
          </div>

          <div class="small-grid" style="margin-top:.6rem">
            <div class="kv"><div class="k">Temperature</div><div class="v">${data.temp !== undefined ? `${data.temp} Â°C` : 'â€”'}</div></div>
            <div class="kv"><div class="k">Feels</div><div class="v">${data.feels !== undefined ? `${data.feels} Â°C` : 'â€”'}</div></div>

            <div class="kv"><div class="k">Humidity</div><div class="v">${data.humidity !== undefined ? `${data.humidity} %` : 'â€”'}</div></div>
            <div class="kv"><div class="k">Wind</div><div class="v">${data.wind !== undefined ? `${data.wind} km/h` : 'â€”'}</div></div>

            <div class="kv"><div class="k">Cloud</div><div class="v">${data.cloud !== undefined ? `${data.cloud} %` : 'â€”'}</div></div>
            <div class="kv"><div class="k">Pressure</div><div class="v">${data.pressure !== undefined ? `${data.pressure} hPa` : 'â€”'}</div></div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:.7rem">
            <div>
              <div class="k">AQI</div>
              <div style="margin-top:.25rem">
                <span class="aqi-pill ${aqiClass}">${aqiNum === null || isNaN(aqiNum) ? 'N/A' : aqiNum} ${aqiNum !== null && !isNaN(aqiNum) ? `Â· ${aqiLabel}` : ''}</span>
              </div>
            </div>

            <div style="text-align:right">
              <div class="k">Day/Night</div>
              <div class="v">${data.is_day === 1 ? 'Day' : (data.is_day === 0 ? 'Night' : 'â€”')}</div>
            </div>
          </div>

        `;

        // attach handlers for actions
        const refreshBtn = card.querySelector('[data-action="refresh"]');
        const removeBtn = card.querySelector('[data-action="remove"]');

        refreshBtn.addEventListener('click', () => refreshLocation(idx));
        removeBtn.addEventListener('click', () => removeLocation(idx));

        gridArea.appendChild(card);
      });
    }

    // ---------- CRUD operations ----------
    async function addLocation(lat, lon, name){
      status.textContent = 'Adding...';
      try {
        const [wJson, aJson] = await Promise.all([fetchWeather(lat, lon).catch(()=>null), fetchAqi(lat, lon).catch(()=>null)]);
        // extract current weather safely
        const wCur = wJson && wJson.current ? wJson.current : null;
        const aqiVal = aJson && aJson.hourly && Array.isArray(aJson.hourly.us_aqi) && aJson.hourly.us_aqi.length ? aJson.hourly.us_aqi[aJson.hourly.us_aqi.length - 1] : null;

        const data = {
          temp: wCur?.temperature_2m ?? null,
          feels: wCur?.apparent_temperature ?? null,
          is_day: wCur?.is_day ?? null,
          wind: wCur?.wind_speed_10m ?? null,
          pressure: wCur?.surface_pressure ?? null,
          cloud: wCur?.cloud_cover ?? null,
          humidity: wCur?.relative_humidity_2m ?? null,
          dew: wCur?.dew_point_2m ?? null,
          aqi: (aqiVal === undefined ? null : (aqiVal === null ? null : Number(aqiVal)))
        };

        const entry = {
          id: uid(),
          name: name || `${lat.toFixed(3)}, ${lon.toFixed(3)}`,
          lat: Number(lat),
          lon: Number(lon),
          data,
          lastUpdated: Date.now()
        };
        locations.push(entry);
        saveState();
        render();
        status.textContent = 'Added';
      } catch (err){
        console.error(err);
        status.textContent = 'Add failed';
        alert('Failed to add location: ' + (err.message || err));
      } finally {
        setTimeout(()=> status.textContent = `Showing ${locations.length} location(s)`, 600);
      }
    }

    async function refreshLocation(index){
      const loc = locations[index];
      if (!loc) return;
      status.textContent = `Refreshing ${loc.name}...`;
      try {
        const [wJson, aJson] = await Promise.all([fetchWeather(loc.lat, loc.lon).catch(()=>null), fetchAqi(loc.lat, loc.lon).catch(()=>null)]);
        const wCur = wJson && wJson.current ? wJson.current : null;
        const aqiVal = aJson && aJson.hourly && Array.isArray(aJson.hourly.us_aqi) && aJson.hourly.us_aqi.length ? aJson.hourly.us_aqi[aJson.hourly.us_aqi.length - 1] : null;
        const data = {
          temp: wCur?.temperature_2m ?? null,
          feels: wCur?.apparent_temperature ?? null,
          is_day: wCur?.is_day ?? null,
          wind: wCur?.wind_speed_10m ?? null,
          pressure: wCur?.surface_pressure ?? null,
          cloud: wCur?.cloud_cover ?? null,
          humidity: wCur?.relative_humidity_2m ?? null,
          dew: wCur?.dew_point_2m ?? null,
          aqi: (aqiVal === undefined ? null : (aqiVal === null ? null : Number(aqiVal)))
        };
        locations[index].data = data;
        locations[index].lastUpdated = Date.now();
        saveState();
        render();
        status.textContent = `Refreshed ${loc.name}`;
      } catch (err){
        console.error(err);
        status.textContent = 'Refresh failed';
        alert('Failed to refresh: ' + (err.message || err));
      } finally {
        setTimeout(()=> status.textContent = `Showing ${locations.length} location(s)`, 600);
      }
    }

    async function refreshAll(){
      if (locations.length === 0) return;
      status.textContent = 'Refreshing all...';
      for (let i=0;i<locations.length;i++){
        // sequential to avoid hammering; could be parallel but mild delay is safer
        // you could parallelize with Promise.all if you want faster updates
        // await refreshLocation(i); // refreshLocation saves and re-renders
        try {
          const loc = locations[i];
          const [wJson, aJson] = await Promise.all([fetchWeather(loc.lat, loc.lon).catch(()=>null), fetchAqi(loc.lat, loc.lon).catch(()=>null)]);
          const wCur = wJson && wJson.current ? wJson.current : null;
          const aqiVal = aJson && aJson.hourly && Array.isArray(aJson.hourly.us_aqi) && aJson.hourly.us_aqi.length ? aJson.hourly.us_aqi[aJson.hourly.us_aqi.length - 1] : null;
          const data = {
            temp: wCur?.temperature_2m ?? null,
            feels: wCur?.apparent_temperature ?? null,
            is_day: wCur?.is_day ?? null,
            wind: wCur?.wind_speed_10m ?? null,
            pressure: wCur?.surface_pressure ?? null,
            cloud: wCur?.cloud_cover ?? null,
            humidity: wCur?.relative_humidity_2m ?? null,
            dew: wCur?.dew_point_2m ?? null,
            aqi: (aqiVal === undefined ? null : (aqiVal === null ? null : Number(aqiVal)))
          };
          locations[i].data = data;
          locations[i].lastUpdated = Date.now();
        } catch(e){
          console.warn('refresh error for index', i, e);
        }
      }
      saveState();
      render();
      status.textContent = 'All refreshed';
      setTimeout(()=> status.textContent = `Showing ${locations.length} location(s)`, 800);
    }

    function removeLocation(index){
      const name = locations[index]?.name || 'item';
      if (!confirm(`Remove ${name}?`)) return;
      locations.splice(index,1);
      saveState();
      render();
      status.textContent = `Removed ${name}`;
      setTimeout(()=> status.textContent = `Showing ${locations.length} location(s)`, 800);
    }

    function clearAll(){
      if (!confirm('Remove all saved locations?')) return;
      locations = [];
      saveState();
      render();
      status.textContent = 'Cleared';
    }

    // ---------- UI interactions ----------
    // Search typing -> geocode suggestions
    let suggestionTimeout = null;
    searchInput.addEventListener('input', (e) => {
      const q = (e.target.value || '').trim();
      if (suggestionTimeout) clearTimeout(suggestionTimeout);
      if (!q) { suggestionsEl.style.display = 'none'; suggestionsEl.innerHTML=''; return; }
      suggestionTimeout = setTimeout(()=> geocodeQuery(q), 300);
    });

    // clicking a suggestion -> add location
    suggestionsEl.addEventListener('click', (ev) => {
      const item = ev.target.closest('.item');
      if (!item) return;
      const lat = Number(item.dataset.lat);
      const lon = Number(item.dataset.lon);
      const name = item.dataset.name || item.textContent;
      suggestionsEl.style.display = 'none';
      searchInput.value = '';
      addLocation(lat, lon, name);
    });

    // add coords button
    addCoordsBtn.addEventListener('click', () => {
      const lat = Number(latInput.value);
      const lon = Number(lonInput.value);
      if (isNaN(lat) || isNaN(lon)){
        alert('Enter valid numbers for lat & lon');
        return;
      }
      addLocation(lat, lon, `Coords: ${lat.toFixed(3)}, ${lon.toFixed(3)}`);
      latInput.value = ''; lonInput.value = '';
    });

    // quick chips
    document.getElementById('quickChips').addEventListener('click', (ev) => {
      const chip = ev.target.closest('.chip');
      if (!chip) return;
      const lat = Number(chip.dataset.lat);
      const lon = Number(chip.dataset.lon);
      const name = chip.textContent.trim();
      addLocation(lat, lon, name);
    });

    updateAllBtn.addEventListener('click', refreshAll);
    clearAllBtn.addEventListener('click', clearAll);

    // hide suggestions when clicking outside
    document.addEventListener('click', (ev) => {
      if (!ev.target.closest('#suggestions') && !ev.target.closest('#searchInput')){
        suggestionsEl.style.display = 'none';
      }
    });

    // ---------- initial behavior: load stored + detect user location ----------
    async function init(){
      render();
      // if stored exist, attempt to refresh them on startup
      if (locations.length > 0){
        // refresh in background
        status.textContent = 'Refreshing saved locations...';
        await refreshAll();
      }

      // detect user location and add as top location if not already present
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          // avoid duplicate within ~10km
          const duplicate = locations.some(l => Math.abs(l.lat - lat) < 0.1 && Math.abs(l.lon - lon) < 0.1);
          if (!duplicate){
            try {
              const [wJson, aJson] = await Promise.all([fetchWeather(lat, lon).catch(()=>null), fetchAqi(lat, lon).catch(()=>null)]);
              const wCur = wJson && wJson.current ? wJson.current : null;
              const aqiVal = aJson && aJson.hourly && Array.isArray(aJson.hourly.us_aqi) && aJson.hourly.us_aqi.length ? aJson.hourly.us_aqi[aJson.hourly.us_aqi.length - 1] : null;
              const data = {
                temp: wCur?.temperature_2m ?? null,
                feels: wCur?.apparent_temperature ?? null,
                is_day: wCur?.is_day ?? null,
                wind: wCur?.wind_speed_10m ?? null,
                pressure: wCur?.surface_pressure ?? null,
                cloud: wCur?.cloud_cover ?? null,
                humidity: wCur?.relative_humidity_2m ?? null,
                dew: wCur?.dew_point_2m ?? null,
                aqi: (aqiVal === undefined ? null : (aqiVal === null ? null : Number(aqiVal)))
              };
              const entry = {
                id: uid(),
                name: 'My Location',
                lat, lon,
                data,
                lastUpdated: Date.now()
              };
              locations.unshift(entry);
              saveState();
              render();
              status.textContent = 'Added your location';
              setTimeout(()=> status.textContent = `Showing ${locations.length} location(s)`, 900);
            } catch(e){
              console.warn('user location add failed', e);
            }
          }
        }, (err) => {
          // permission denied or other error â€” OK to ignore silently
          console.warn('geolocation error', err);
        }, { enableHighAccuracy: false, timeout: 5000 });
      }
    }

    // ---------- utility: geocodeQuery implementation ----------
    // (kept here for readability; uses Open-Meteo geocoding)
    let lastGeoReq = 0;
    async function geocodeQuery(q){
      lastGeoReq++;
      const thisReq = lastGeoReq;
      suggestionsEl.style.display = 'none';
      suggestionsEl.innerHTML = '<div class="item">Searchingâ€¦</div>';
      suggestionsEl.style.display = 'block';
      try {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=en`;
        const r = await fetch(url);
        const json = await r.json();
        if (thisReq !== lastGeoReq) return; // ignore stale
        if (!json || !Array.isArray(json.results) || json.results.length === 0){
          suggestionsEl.innerHTML = '<div class="item">No results</div>';
          return;
        }
        suggestionsEl.innerHTML = json.results.map(r => {
          const label = `${r.name}${r.admin1 ? ', '+r.admin1 : ''}${r.country ? ', '+r.country : ''}`;
          const safe = escapeHtml(label);
          return `<div class="item" data-lat="${r.latitude}" data-lon="${r.longitude}" data-name="${safe}">${safe}</div>`;
        }).join('');
      } catch(e){
        console.warn(e);
        suggestionsEl.innerHTML = '<div class="item">Error fetching</div>';
      }
    }

    // ---------- start ----------
    init();

  </script>
</body>
</html>
